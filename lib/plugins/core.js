'use strict';Object.defineProperty(exports,"__esModule",{value:true});var _extends=Object.assign||function(target){for(var i=1;i<arguments.length;i++){var source=arguments[i];for(var key in source){if(Object.prototype.hasOwnProperty.call(source,key)){target[key]=source[key];}}}return target;};var _jsxFileName='src/plugins/core.js';var _slateBase64Serializer=require('slate-base64-serializer');var _slateBase64Serializer2=_interopRequireDefault(_slateBase64Serializer);var _debug=require('debug');var _debug2=_interopRequireDefault(_debug);var _slatePlainSerializer=require('slate-plain-serializer');var _slatePlainSerializer2=_interopRequireDefault(_slatePlainSerializer);var _react=require('react');var _react2=_interopRequireDefault(_react);var _reactNative=require('react-native');var _slate=require('slate');var _content=require('../components/content');var _content2=_interopRequireDefault(_content);var _placeholder=require('../components/placeholder');var _placeholder2=_interopRequireDefault(_placeholder);var _getPoint=require('../utils/get-point');var _getPoint2=_interopRequireDefault(_getPoint);var _findDomNode=require('../utils/find-dom-node');var _findDomNode2=_interopRequireDefault(_findDomNode);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}var debug=(0,_debug2.default)('slate:core');function Plugin(){var options=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};var placeholder=options.placeholder,placeholderClassName=options.placeholderClassName,placeholderStyle=options.placeholderStyle;function onBeforeChange(change,editor){var state=change.state;var schema=editor.getSchema();var prevState=editor.getState();if(prevState&&state.document==prevState.document)return;change.normalize(schema);debug('onBeforeChange');}function onBeforeInput(e,data,change,editor){debug('onBeforeInput',{data:data});e.preventDefault();change.insertText(e.data);}function onBlur(e,data,change){debug('onBlur',{data:data});change.blur();}function onCopy(e,data,change){debug('onCopy',data);onCutOrCopy(e,data,change);}function onCut(e,data,change,editor){debug('onCut',data);onCutOrCopy(e,data,change);editor.change(function(t){return t.delete();});}function onCutOrCopy(e,data,change){var _this=this;var clipItem=function clipItem(){return regeneratorRuntime.async(function clipItem$(_context){while(1){switch(_context.prev=_context.next){case 0:_context.next=2;return regeneratorRuntime.awrap(_reactNative.Clipboard.getString());case 2:return _context.abrupt('return',_context.sent);case 3:case'end':return _context.stop();}}},null,_this);};var state=change.state;var endBlock=state.endBlock,endInline=state.endInline;var isVoidBlock=endBlock&&endBlock.isVoid;var isVoidInline=endInline&&endInline.isVoid;var isVoid=isVoidBlock||isVoidInline;var fragment=data.fragment;var encoded=_slateBase64Serializer2.default.serializeNode(fragment);var contents=clipItem();}function onDrop(e,data,change){debug('onDrop',{data:data});switch(data.type){case'text':case'html':return onDropText(e,data,change);case'fragment':return onDropFragment(e,data,change);case'node':return onDropNode(e,data,change);}}function onDropNode(e,data,change){debug('onDropNode',{data:data});var state=change.state;var selection=state.selection;var node=data.node,target=data.target,isInternal=data.isInternal;if(isInternal&&selection.endKey==target.endKey&&selection.endOffset<target.endOffset){target=target.move(selection.startKey==selection.endKey?0-selection.endOffset+selection.startOffset:0-selection.endOffset);}if(isInternal){change.delete();}if(_slate.Block.isBlock(node)){change.select(target).insertBlock(node).removeNodeByKey(node.key);}if(_slate.Inline.isInline(node)){change.select(target).insertInline(node).removeNodeByKey(node.key);}}function onDropFragment(e,data,change){debug('onDropFragment',{data:data});var state=change.state;var selection=state.selection;var fragment=data.fragment,target=data.target,isInternal=data.isInternal;if(isInternal&&selection.endKey==target.endKey&&selection.endOffset<target.endOffset){target=target.move(selection.startKey==selection.endKey?0-selection.endOffset+selection.startOffset:0-selection.endOffset);}if(isInternal){change.delete();}change.select(target).insertFragment(fragment);}function onDropText(e,data,change){debug('onDropText',{data:data});var state=change.state;var document=state.document;var text=data.text,target=data.target;var anchorKey=target.anchorKey;change.select(target);var hasVoidParent=document.hasVoidParent(anchorKey);if(hasVoidParent){var node=document.getNode(anchorKey);while(hasVoidParent){node=document.getNextText(node.key);if(!node)break;hasVoidParent=document.hasVoidParent(node.key);}if(node)change.collapseToStartOf(node);}text.split('\n').forEach(function(line,i){if(i>0)change.splitBlock();change.insertText(line);});}function onKeyDown(e,data,change){debug('onKeyDown',{data:data});switch(data.key){case'enter':return onKeyDownEnter(e,data,change);case'backspace':return onKeyDownBackspace(e,data,change);case'delete':return onKeyDownDelete(e,data,change);case'left':return onKeyDownLeft(e,data,change);case'right':return onKeyDownRight(e,data,change);case'up':return onKeyDownUp(e,data,change);case'down':return onKeyDownDown(e,data,change);case'd':return onKeyDownD(e,data,change);case'h':return onKeyDownH(e,data,change);case'k':return onKeyDownK(e,data,change);case'y':return onKeyDownY(e,data,change);case'z':return onKeyDownZ(e,data,change);}}function onKeyDownEnter(e,data,change){var state=change.state;var document=state.document,startKey=state.startKey;var hasVoidParent=document.hasVoidParent(startKey);if(hasVoidParent){var text=document.getNextText(startKey);if(!text)return;change.collapseToStartOf(text);return;}change.splitBlock();}function onKeyDownBackspace(e,data,change){var boundary='Char';if(data.isWord)boundary='Word';if(data.isLine)boundary='Line';change['delete'+boundary+'Backward']();}function onKeyDownDelete(e,data,change){var boundary='Char';if(data.isWord)boundary='Word';if(data.isLine)boundary='Line';change['delete'+boundary+'Forward']();}function onKeyDownLeft(e,data,change){var state=change.state;if(data.isCtrl)return;if(data.isAlt)return;if(state.isExpanded)return;var document=state.document,startKey=state.startKey,startText=state.startText;var hasVoidParent=document.hasVoidParent(startKey);if(startText.text==''||hasVoidParent){e.preventDefault();var previous=document.getPreviousText(startKey);if(!previous)return;var startBlock=state.startBlock;var previousBlock=document.getClosestBlock(previous.key);var previousInline=document.getClosestInline(previous.key);if(previousBlock===startBlock&&previousInline&&!previousInline.isVoid){var extendOrMove=data.isShift?'extend':'move';change.collapseToEndOf(previous)[extendOrMove](-1);return;}change.collapseToEndOf(previous);}}function onKeyDownRight(e,data,change){var state=change.state;if(data.isCtrl)return;if(data.isAlt)return;if(state.isExpanded)return;var document=state.document,startKey=state.startKey,startText=state.startText;var hasVoidParent=document.hasVoidParent(startKey);if(startText.text==''||hasVoidParent){e.preventDefault();var next=document.getNextText(startKey);if(!next)return;if(document.hasVoidParent(next.key)){change.collapseToEndOf(next);return;}var startBlock=state.startBlock;var nextBlock=document.getClosestBlock(next.key);var nextInline=document.getClosestInline(next.key);if(nextBlock==startBlock&&nextInline){var extendOrMove=data.isShift?'extend':'move';change.collapseToStartOf(next)[extendOrMove](1);return;}change.collapseToStartOf(next);}}function onKeyDownUp(e,data,change){var state=change.state;var selection=state.selection,document=state.document,focusKey=state.focusKey,focusBlock=state.focusBlock;var transform=data.isShift?'extendToStartOf':'collapseToStartOf';var block=selection.hasFocusAtStartOf(focusBlock)?document.getPreviousBlock(focusKey):focusBlock;if(!block)return;var text=block.getFirstText();e.preventDefault();change[transform](text);}function onKeyDownDown(e,data,change){var state=change.state;var selection=state.selection,document=state.document,focusKey=state.focusKey,focusBlock=state.focusBlock;var transform=data.isShift?'extendToEndOf':'collapseToEndOf';var block=selection.hasFocusAtEndOf(focusBlock)?document.getNextBlock(focusKey):focusBlock;if(!block)return;var text=block.getLastText();e.preventDefault();change[transform](text);}function onKeyDownD(e,data,change){e.preventDefault();change.deleteCharForward();}function onKeyDownH(e,data,change){e.preventDefault();change.deleteCharBackward();}function onKeyDownK(e,data,change){e.preventDefault();change.deleteLineForward();}function onKeyDownY(e,data,change){if(!data.isMod)return;change.redo();}function onKeyDownZ(e,data,change){if(!data.isMod)return;change[data.isShift?'redo':'undo']();}function onPaste(e,data,change){debug('onPaste',{data:data});switch(data.type){case'fragment':return onPasteFragment(e,data,change);case'text':case'html':return onPasteText(e,data,change);}}function onPasteFragment(e,data,change){debug('onPasteFragment',{data:data});change.insertFragment(data.fragment);}function onPasteText(e,data,change){debug('onPasteText',{data:data});var state=change.state;var document=state.document,selection=state.selection,startBlock=state.startBlock;if(startBlock.isVoid)return;var text=data.text;var defaultBlock=startBlock;var defaultMarks=document.getMarksAtRange(selection.collapseToStart());var fragment=_slatePlainSerializer2.default.deserialize(text,{defaultBlock:defaultBlock,defaultMarks:defaultMarks}).document;change.insertFragment(fragment);}function onSelect(e,data,change){debug('onSelect',{data:data});change.select(data.selection);}function render(props,state,editor){return _react2.default.createElement(_content2.default,{autoCorrect:props.autoCorrect,autoFocus:props.autoFocus,className:props.className,children:props.children,editor:editor,onBeforeInput:editor.onBeforeInput,onBlur:editor.onBlur,onFocus:editor.onFocus,onCopy:editor.onCopy,onCut:editor.onCut,onDrop:editor.onDrop,onKeyDown:editor.onKeyDown,onKeyUp:editor.onKeyUp,onPaste:editor.onPaste,onSelect:editor.onSelect,readOnly:props.readOnly,role:props.role,schema:editor.getSchema(),spellCheck:props.spellCheck,state:state,style:props.style,tabIndex:props.tabIndex,tagName:props.tagName,__source:{fileName:_jsxFileName,lineNumber:666}});}var BLOCK_RENDER_RULE={match:function match(node){return node.kind=='block';},render:function render(props){return _react2.default.createElement(_reactNative.View,_extends({},props.attributes,{style:{position:'relative'},__source:{fileName:_jsxFileName,lineNumber:706}}),props.children,placeholder?_react2.default.createElement(_placeholder2.default,{className:placeholderClassName,node:props.node,parent:props.state.document,state:props.state,style:placeholderStyle,__source:{fileName:_jsxFileName,lineNumber:709}},placeholder):null);}};var INLINE_RENDER_RULE={match:function match(node){return node.kind=='inline';},render:function render(props){return _react2.default.createElement(_reactNative.View,_extends({},props.attributes,{style:{position:'relative'},__source:{fileName:_jsxFileName,lineNumber:736}}),props.children);}};var schema={rules:[BLOCK_RENDER_RULE,INLINE_RENDER_RULE]};return{onBeforeChange:onBeforeChange,onBeforeInput:onBeforeInput,onBlur:onBlur,onCopy:onCopy,onCut:onCut,onDrop:onDrop,onKeyDown:onKeyDown,onPaste:onPaste,onSelect:onSelect,render:render,schema:schema};}exports.default=Plugin;