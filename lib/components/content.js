'use strict';Object.defineProperty(exports,"__esModule",{value:true});var _extends=Object.assign||function(target){for(var i=1;i<arguments.length;i++){var source=arguments[i];for(var key in source){if(Object.prototype.hasOwnProperty.call(source,key)){target[key]=source[key];}}}return target;};var _jsxFileName='src/components/content.js';var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor);}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor;};}();var _slateBase64Serializer=require('slate-base64-serializer');var _slateBase64Serializer2=_interopRequireDefault(_slateBase64Serializer);var _debug=require('debug');var _debug2=_interopRequireDefault(_debug);var _react=require('react');var _react2=_interopRequireDefault(_react);var _slatePropTypes=require('slate-prop-types');var _slatePropTypes2=_interopRequireDefault(_slatePropTypes);var _propTypes=require('prop-types');var _propTypes2=_interopRequireDefault(_propTypes);var _keycode=require('keycode');var _keycode2=_interopRequireDefault(_keycode);var _slate=require('slate');var _transferTypes=require('../constants/transfer-types');var _transferTypes2=_interopRequireDefault(_transferTypes);var _node=require('./node');var _node2=_interopRequireDefault(_node);var _findClosestNode=require('../utils/find-closest-node');var _findClosestNode2=_interopRequireDefault(_findClosestNode);var _getPoint=require('../utils/get-point');var _getPoint2=_interopRequireDefault(_getPoint);var _getTransferData=require('../utils/get-transfer-data');var _getTransferData2=_interopRequireDefault(_getTransferData);var _setTransferData=require('../utils/set-transfer-data');var _setTransferData2=_interopRequireDefault(_setTransferData);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function");}}function _possibleConstructorReturn(self,call){if(!self){throw new ReferenceError("this hasn't been initialised - super() hasn't been called");}return call&&(typeof call==="object"||typeof call==="function")?call:self;}function _inherits(subClass,superClass){if(typeof superClass!=="function"&&superClass!==null){throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:false,writable:true,configurable:true}});if(superClass)Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass;}var debug=(0,_debug2.default)('slate:content');var Content=function(_React$Component){_inherits(Content,_React$Component);function Content(props){_classCallCheck(this,Content);var _this=_possibleConstructorReturn(this,(Content.__proto__||Object.getPrototypeOf(Content)).call(this,props));_this.componentDidMount=function(){if(_this.props.autoFocus){_this.element.focus();}};_this.componentDidUpdate=function(){};_this.ref=function(element){_this.element=element;};_this.isInEditor=function(target){var element=_this.element;var el=target.nodeType===3?target.parentNode:target;return el.isContentEditable&&(el===element||(0,_findClosestNode2.default)(el,'[data-slate-editor]')===element);};_this.onBeforeInput=function(event){if(_this.props.readOnly)return;if(!_this.isInEditor(event.target))return;var data={};debug('onBeforeInput',{event:event,data:data});_this.props.onBeforeInput(event,data);};_this.onBlur=function(event){if(_this.props.readOnly)return;if(_this.tmp.isCopying)return;if(!_this.isInEditor(event.target))return;var data={};debug('onBlur',{event:event,data:data});_this.props.onBlur(event,data);};_this.onFocus=function(event){if(_this.props.readOnly)return;if(_this.tmp.isCopying)return;if(!_this.isInEditor(event.target))return;var data={};debug('onFocus',{event:event,data:data});_this.props.onFocus(event,data);};_this.onCompositionStart=function(event){if(!_this.isInEditor(event.target))return;_this.tmp.isComposing=true;_this.tmp.compositions++;debug('onCompositionStart',{event:event});};_this.onCompositionEnd=function(event){if(!_this.isInEditor(event.target))return;_this.tmp.forces++;var count=_this.tmp.compositions;setTimeout(function(){if(_this.tmp.compositions>count)return;_this.tmp.isComposing=false;});debug('onCompositionEnd',{event:event});};_this.onCopy=function(event){if(!_this.isInEditor(event.target))return;_this.tmp.isCopying=true;var state=_this.props.state;var data={};data.type='fragment';data.fragment=state.fragment;debug('onCopy',{event:event,data:data});_this.props.onCopy(event,data);};_this.onCut=function(event){if(_this.props.readOnly)return;if(!_this.isInEditor(event.target))return;_this.tmp.isCopying=true;var state=_this.props.state;var data={};data.type='fragment';data.fragment=state.fragment;debug('onCut',{event:event,data:data});_this.props.onCut(event,data);};_this.onDragEnd=function(event){if(!_this.isInEditor(event.target))return;_this.tmp.isDragging=false;_this.tmp.isInternalDrag=null;debug('onDragEnd',{event:event});};_this.onDragOver=function(event){if(!_this.isInEditor(event.target))return;if(_this.tmp.isDragging)return;_this.tmp.isDragging=true;_this.tmp.isInternalDrag=false;debug('onDragOver',{event:event});};_this.onDragStart=function(event){if(!_this.isInEditor(event.target))return;_this.tmp.isDragging=true;_this.tmp.isInternalDrag=true;var dataTransfer=event.nativeEvent.dataTransfer;var data=(0,_getTransferData2.default)(dataTransfer);if(data.type=='node')return;var state=_this.props.state;var fragment=state.fragment;var encoded=_slateBase64Serializer2.default.serializeNode(fragment);(0,_setTransferData2.default)(dataTransfer,_transferTypes2.default.FRAGMENT,encoded);debug('onDragStart',{event:event});};_this.onDrop=function(event){event.preventDefault();if(_this.props.readOnly)return;if(!_this.isInEditor(event.target))return;var _this$props=_this.props,state=_this$props.state,editor=_this$props.editor;var nativeEvent=event.nativeEvent;var dataTransfer=nativeEvent.dataTransfer;var data=(0,_getTransferData2.default)(dataTransfer);var range=void 0;var startContainer=range.startContainer,startOffset=range.startOffset;var point=(0,_getPoint2.default)(startContainer,startOffset,state,editor);if(!point)return;var target=_slate.Selection.create({anchorKey:point.key,anchorOffset:point.offset,focusKey:point.key,focusOffset:point.offset,isFocused:true});data.target=target;try{data.effect=dataTransfer.dropEffect;}catch(err){data.effect=null;}if(data.type=='fragment'||data.type=='node'){data.isInternal=_this.tmp.isInternalDrag;}debug('onDrop',{event:event,data:data});_this.props.onDrop(event,data);};_this.onInput=function(event){if(_this.tmp.isComposing)return;if(_this.props.state.isBlurred)return;if(!_this.isInEditor(event.target))return;debug('onInput',{event:event});var _this$props2=_this.props,state=_this$props2.state,editor=_this$props2.editor;editor.change(function(change){change.delete().select(after);});};_this.onKeyDown=function(event){if(_this.props.readOnly)return;if(!_this.isInEditor(event.target))return;var which=event.which;var key=(0,_keycode2.default)(which);var data={};if(key=='shift'){_this.tmp.isShifting=true;}if(_this.tmp.isComposing&&(key=='left'||key=='right'||key=='up'||key=='down')){event.preventDefault();return;}if(key=='enter'||key=='backspace'||key=='delete'||key=='b'||key=='i'||key=='y'||key=='z'){event.preventDefault();}debug('onKeyDown',{event:event,data:data});_this.props.onKeyDown(event,data);};_this.onKeyUp=function(event){var which=event.which;var key=(0,_keycode2.default)(which);var data={};if(key=='shift'){_this.tmp.isShifting=false;}debug('onKeyUp',{event:event,data:data});_this.props.onKeyUp(event,data);};_this.onPaste=function(event){if(_this.props.readOnly)return;if(!_this.isInEditor(event.target))return;var data=(0,_getTransferData2.default)(event.clipboardData);data.isShift=!!_this.tmp.isShifting;debug('onPaste',{event:event,data:data});event.preventDefault();_this.props.onPaste(event,data);};_this.onSelect=function(event){if(_this.props.readOnly)return;if(_this.tmp.isCopying)return;if(_this.tmp.isComposing)return;if(_this.tmp.isSelecting)return;if(!_this.isInEditor(event.target))return;var _this$props3=_this.props,state=_this$props3.state,editor=_this$props3.editor;var document=state.document,selection=state.selection;var data={};debug('onSelect',{event:event,data:data});_this.props.onSelect(event,data);};_this.renderNode=function(child,isSelected){var _this$props4=_this.props,editor=_this$props4.editor,readOnly=_this$props4.readOnly,schema=_this$props4.schema,state=_this$props4.state;var document=state.document;return _react2.default.createElement(_node2.default,{block:null,editor:editor,isSelected:isSelected,key:child.key,node:child,parent:document,readOnly:readOnly,schema:schema,state:state,__source:{fileName:_jsxFileName,lineNumber:595}});};_this.tmp={};_this.tmp.compositions=0;_this.tmp.forces=0;return _this;}_createClass(Content,[{key:'render',value:function render(){var _this2=this;var props=this.props;var className=props.className,readOnly=props.readOnly,state=props.state,tabIndex=props.tabIndex,role=props.role,tagName=props.tagName;var Container=tagName;var document=state.document,selection=state.selection;var indexes=document.getSelectionIndexes(selection,selection.isFocused);var children=document.nodes.toArray().map(function(child,i){var isSelected=!!indexes&&indexes.start<=i&&i<indexes.end;return _this2.renderNode(child,isSelected);});var style=_extends({outline:'none',whiteSpace:'pre-wrap',wordWrap:'break-word'},props.style);var spellCheck=props.spellCheck;debug('render',{props:props});return _react2.default.createElement(Container,{'data-slate-editor':true,key:this.tmp.forces,ref:this.ref,'data-key':document.key,contentEditable:!readOnly,suppressContentEditableWarning:true,className:className,onBeforeInput:this.onBeforeInput,onBlur:this.onBlur,onFocus:this.onFocus,onCompositionEnd:this.onCompositionEnd,onCompositionStart:this.onCompositionStart,onCopy:this.onCopy,onCut:this.onCut,onDragEnd:this.onDragEnd,onDragOver:this.onDragOver,onDragStart:this.onDragStart,onDrop:this.onDrop,onInput:this.onInput,onKeyDown:this.onKeyDown,onKeyUp:this.onKeyUp,onPaste:this.onPaste,onSelect:this.onSelect,autoCorrect:props.autoCorrect?'on':'off',spellCheck:spellCheck,style:style,role:readOnly?null:role||'textbox',tabIndex:tabIndex,__source:{fileName:_jsxFileName,lineNumber:547}},children,this.props.children);}}]);return Content;}(_react2.default.Component);Content.propTypes={autoCorrect:_propTypes2.default.bool.isRequired,autoFocus:_propTypes2.default.bool.isRequired,children:_propTypes2.default.array.isRequired,className:_propTypes2.default.string,editor:_propTypes2.default.object.isRequired,onBeforeInput:_propTypes2.default.func.isRequired,onBlur:_propTypes2.default.func.isRequired,onCopy:_propTypes2.default.func.isRequired,onCut:_propTypes2.default.func.isRequired,onDrop:_propTypes2.default.func.isRequired,onFocus:_propTypes2.default.func.isRequired,onKeyDown:_propTypes2.default.func.isRequired,onKeyUp:_propTypes2.default.func.isRequired,onPaste:_propTypes2.default.func.isRequired,onSelect:_propTypes2.default.func.isRequired,readOnly:_propTypes2.default.bool.isRequired,role:_propTypes2.default.string,schema:_slatePropTypes2.default.schema.isRequired,spellCheck:_propTypes2.default.bool.isRequired,state:_slatePropTypes2.default.state.isRequired,style:_propTypes2.default.object,tabIndex:_propTypes2.default.number,tagName:_propTypes2.default.string};Content.defaultProps={style:{},tagName:'View'};exports.default=Content;