'use strict';Object.defineProperty(exports,"__esModule",{value:true});var _extends=Object.assign||function(target){for(var i=1;i<arguments.length;i++){var source=arguments[i];for(var key in source){if(Object.prototype.hasOwnProperty.call(source,key)){target[key]=source[key];}}}return target;};var _jsxFileName='src/components/node.js';var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor);}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor;};}();var _slateBase64Serializer=require('slate-base64-serializer');var _slateBase64Serializer2=_interopRequireDefault(_slateBase64Serializer);var _debug=require('debug');var _debug2=_interopRequireDefault(_debug);var _react=require('react');var _react2=_interopRequireDefault(_react);var _reactNative=require('react-native');var _slatePropTypes=require('slate-prop-types');var _slatePropTypes2=_interopRequireDefault(_slatePropTypes);var _slateDevLogger=require('slate-dev-logger');var _slateDevLogger2=_interopRequireDefault(_slateDevLogger);var _propTypes=require('prop-types');var _propTypes2=_interopRequireDefault(_propTypes);var _transferTypes=require('../constants/transfer-types');var _transferTypes2=_interopRequireDefault(_transferTypes);var _leaf=require('./leaf');var _leaf2=_interopRequireDefault(_leaf);var _void=require('./void');var _void2=_interopRequireDefault(_void);var _setTransferData=require('../utils/set-transfer-data');var _setTransferData2=_interopRequireDefault(_setTransferData);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function");}}function _possibleConstructorReturn(self,call){if(!self){throw new ReferenceError("this hasn't been initialised - super() hasn't been called");}return call&&(typeof call==="object"||typeof call==="function")?call:self;}function _inherits(subClass,superClass){if(typeof superClass!=="function"&&superClass!==null){throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:false,writable:true,configurable:true}});if(superClass)Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass;}var debug=(0,_debug2.default)('slate:node');var Node=function(_React$Component){_inherits(Node,_React$Component);function Node(props){_classCallCheck(this,Node);var _this=_possibleConstructorReturn(this,(Node.__proto__||Object.getPrototypeOf(Node)).call(this,props));_initialiseProps.call(_this);var node=props.node,schema=props.schema;_this.state={};_this.state.Component=node.kind=='text'?null:node.getComponent(schema);return _this;}_createClass(Node,[{key:'render',value:function render(){var props=this.props;var node=this.props.node;this.debug('render',{props:props});return node.kind=='text'?this.renderText():this.renderElement();}}]);return Node;}(_react2.default.Component);Node.propTypes={block:_slatePropTypes2.default.block,editor:_propTypes2.default.object.isRequired,isSelected:_propTypes2.default.bool.isRequired,node:_slatePropTypes2.default.node.isRequired,parent:_slatePropTypes2.default.node.isRequired,readOnly:_propTypes2.default.bool.isRequired,schema:_slatePropTypes2.default.schema.isRequired,state:_slatePropTypes2.default.state.isRequired};var _initialiseProps=function _initialiseProps(){var _this2=this;this.debug=function(message){for(var _len=arguments.length,args=Array(_len>1?_len-1:0),_key=1;_key<_len;_key++){args[_key-1]=arguments[_key];}var node=_this2.props.node;var key=node.key,kind=node.kind,type=node.type;var id=kind=='text'?key+' ('+kind+')':key+' ('+type+')';debug.apply(undefined,[message,''+id].concat(args));};this.componentWillReceiveProps=function(props){if(props.node.kind=='text')return;if(props.node==_this2.props.node)return;var Component=props.node.getComponent(props.schema);_this2.setState({Component:Component});};this.shouldComponentUpdate=function(nextProps){var props=_this2.props;var Component=_this2.state.Component;var n=nextProps;var p=props;if(Component&&Component.suppressShouldComponentUpdate){_slateDevLogger2.default.deprecate('2.2.0','The `suppressShouldComponentUpdate` property is deprecated because it led to an important performance loss, use `shouldNodeComponentUpdate` instead.');return true;}if(Component&&Component.shouldNodeComponentUpdate){var shouldUpdate=Component.shouldNodeComponentUpdate(p,n);if(shouldUpdate){return true;}if(shouldUpdate===false){_slateDevLogger2.default.warn('Returning false in `shouldNodeComponentUpdate` does not disable Slate\'s internal `shouldComponentUpdate` logic. If you want to prevent updates, use React\'s `shouldComponentUpdate` instead.');}}if(n.readOnly!=p.readOnly)return true;if(n.node!=p.node)return true;if(n.isSelected||p.isSelected)return true;if(n.node.kind=='text'&&n.schema.hasDecorators){var nDecorators=n.state.document.getDescendantDecorators(n.node.key,n.schema);var pDecorators=p.state.document.getDescendantDecorators(p.node.key,p.schema);var nRanges=n.node.getRanges(nDecorators);var pRanges=p.node.getRanges(pDecorators);if(!nRanges.equals(pRanges))return true;}if(n.node.kind=='text'&&n.parent.kind=='block'){var pLast=p.parent.nodes.last();var nLast=n.parent.nodes.last();if(p.node==pLast&&n.node!=nLast)return true;}return false;};this.onDragStart=function(e){var node=_this2.props.node;if(!node.isVoid){return;}var encoded=_slateBase64Serializer2.default.serializeNode(node,{preserveKeys:true});var dataTransfer=e.nativeEvent.dataTransfer;(0,_setTransferData2.default)(dataTransfer,_transferTypes2.default.NODE,encoded);_this2.debug('onDragStart',e);};this.renderNode=function(child,isSelected){var _props=_this2.props,block=_props.block,editor=_props.editor,node=_props.node,readOnly=_props.readOnly,schema=_props.schema,state=_props.state;return _react2.default.createElement(Node,{block:node.kind=='block'?node:block,editor:editor,isSelected:isSelected,key:child.key,node:child,parent:node,readOnly:readOnly,schema:schema,state:state,__source:{fileName:_jsxFileName,lineNumber:214}});};this.renderElement=function(){var _props2=_this2.props,editor=_props2.editor,isSelected=_props2.isSelected,node=_props2.node,parent=_props2.parent,readOnly=_props2.readOnly,state=_props2.state;var Component=_this2.state.Component;var selection=state.selection;var indexes=node.getSelectionIndexes(selection,isSelected);var children=node.nodes.toArray().map(function(child,i){var isChildSelected=!!indexes&&indexes.start<=i&&i<indexes.end;return _this2.renderNode(child,isChildSelected);});var attributes={'data-key':node.key,'onDragStart':_this2.onDragStart};if(node.kind=='block'&&node.nodes.first().kind!='block'){var direction=node.getTextDirection();if(direction=='rtl')attributes.dir='rtl';}var element=_react2.default.createElement(Component,{attributes:attributes,editor:editor,isSelected:isSelected,key:node.key,node:node,parent:parent,readOnly:readOnly,state:state,__source:{fileName:_jsxFileName,lineNumber:259}},children);return node.isVoid?_react2.default.createElement(_void2.default,_extends({},_this2.props,{__source:{fileName:_jsxFileName,lineNumber:274}}),element):element;};this.renderText=function(){var _props3=_this2.props,node=_props3.node,schema=_props3.schema,state=_props3.state;var document=state.document;var decorators=schema.hasDecorators?document.getDescendantDecorators(node.key,schema):[];var ranges=node.getRanges(decorators);var offset=0;var leaves=ranges.map(function(range,i){var leaf=_this2.renderLeaf(ranges,range,i,offset);offset+=range.text.length;return leaf;});return _react2.default.createElement(_reactNative.View,{'data-key':node.key,__source:{fileName:_jsxFileName,lineNumber:298}},leaves);};this.renderLeaf=function(ranges,range,index,offset){var _props4=_this2.props,block=_props4.block,node=_props4.node,parent=_props4.parent,schema=_props4.schema,state=_props4.state,editor=_props4.editor;var text=range.text,marks=range.marks;return _react2.default.createElement(_leaf2.default,{key:node.key+'-'+index,block:block,editor:editor,index:index,marks:marks,node:node,offset:offset,parent:parent,ranges:ranges,schema:schema,state:state,text:text,__source:{fileName:_jsxFileName,lineNumber:319}});};};exports.default=Node;